name: Preview Screenshots

on:
  workflow_run:
    workflows: ["Preview Deployment"]
    types:
      - completed

jobs:
  screenshots:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    name: Capture Screenshots
    permissions:
      contents: read
      pull-requests: write
      actions: read

    steps:
      - uses: actions/checkout@v4

      - name: Get PR number from workflow run
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            // Get PR number from the workflow run
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;

            if (!prNumber) {
              // Fallback: search for PR by head SHA
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
                state: 'open',
              });
              if (prs.data.length > 0) {
                core.setOutput('number', prs.data[0].number);
                return;
              }
              core.setFailed('Could not determine PR number');
              return;
            }

            core.setOutput('number', prNumber);

      - name: Build preview URL
        id: preview
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          PREVIEW_URL="https://breathe-together-v2-pr-${PR_NUMBER}.palladio-registry.workers.dev"
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "Preview URL: ${PREVIEW_URL}"

      - name: Wait for preview to be ready
        run: |
          echo "Waiting for preview deployment to be accessible..."
          PREVIEW_URL="${{ steps.preview.outputs.url }}"
          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PREVIEW_URL" || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Preview is ready (HTTP $HTTP_STATUS)"
              break
            fi
            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: HTTP $HTTP_STATUS, waiting..."
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Warning: Preview may not be fully ready, proceeding anyway..."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright@latest
          npx playwright install chromium --with-deps

      - name: Create screenshot script
        run: |
          cat > screenshot.mjs << 'EOF'
          import { chromium } from 'playwright';
          import { mkdir } from 'fs/promises';
          import { existsSync } from 'fs';

          const PREVIEW_URL = process.env.PREVIEW_URL;
          const SCREENSHOTS_DIR = './screenshots';

          // Viewport configurations
          const viewports = [
            { name: 'desktop', width: 1920, height: 1080 },
            { name: 'tablet', width: 768, height: 1024 },
            { name: 'mobile', width: 375, height: 667 },
          ];

          async function captureScreenshots() {
            if (!existsSync(SCREENSHOTS_DIR)) {
              await mkdir(SCREENSHOTS_DIR, { recursive: true });
            }

            const browser = await chromium.launch({
              args: ['--use-gl=angle', '--use-angle=swiftshader'],
            });

            console.log(`Capturing screenshots from: ${PREVIEW_URL}`);

            for (const viewport of viewports) {
              console.log(`\nCapturing ${viewport.name} (${viewport.width}x${viewport.height})...`);

              const context = await browser.newContext({
                viewport: { width: viewport.width, height: viewport.height },
                deviceScaleFactor: 2,
              });

              const page = await context.newPage();

              try {
                // Navigate to the preview URL
                await page.goto(PREVIEW_URL, {
                  waitUntil: 'networkidle',
                  timeout: 60000,
                });

                // Wait for WebGL canvas to render
                await page.waitForSelector('canvas', { timeout: 30000 });

                // Additional wait for Three.js scene to initialize and render
                await page.waitForTimeout(5000);

                // Capture initial state
                await page.screenshot({
                  path: `${SCREENSHOTS_DIR}/${viewport.name}-initial.png`,
                  fullPage: false,
                });
                console.log(`  ‚úì Captured ${viewport.name}-initial.png`);

                // Wait a few seconds for breathing animation to progress
                await page.waitForTimeout(4000);

                // Capture mid-cycle state
                await page.screenshot({
                  path: `${SCREENSHOTS_DIR}/${viewport.name}-animation.png`,
                  fullPage: false,
                });
                console.log(`  ‚úì Captured ${viewport.name}-animation.png`);

              } catch (error) {
                console.error(`  ‚úó Error capturing ${viewport.name}:`, error.message);

                // Try to capture whatever is on screen for debugging
                try {
                  await page.screenshot({
                    path: `${SCREENSHOTS_DIR}/${viewport.name}-error.png`,
                    fullPage: false,
                  });
                  console.log(`  ‚úì Captured ${viewport.name}-error.png (fallback)`);
                } catch (e) {
                  console.error(`  ‚úó Could not capture fallback screenshot`);
                }
              } finally {
                await context.close();
              }
            }

            await browser.close();
            console.log('\nScreenshot capture complete!');
          }

          captureScreenshots().catch((error) => {
            console.error('Fatal error:', error);
            process.exit(1);
          });
          EOF

      - name: Capture screenshots
        env:
          PREVIEW_URL: ${{ steps.preview.outputs.url }}
        run: node screenshot.mjs

      - name: Upload screenshots as artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-screenshots-pr-${{ steps.pr.outputs.number }}
          path: screenshots/
          retention-days: 30

      - name: Comment PR with screenshots
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          PREVIEW_URL: ${{ steps.preview.outputs.url }}
          WORKFLOW_RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const fs = require('fs');
            const prNumber = parseInt(process.env.PR_NUMBER);
            const previewUrl = process.env.PREVIEW_URL;
            const workflowRunId = process.env.WORKFLOW_RUN_ID;
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const artifactUrl = `${repoUrl}/actions/runs/${workflowRunId}`;
            const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

            // List captured screenshots
            const screenshotsDir = './screenshots';
            let screenshotFiles = [];
            try {
              screenshotFiles = fs.readdirSync(screenshotsDir).filter(f => f.endsWith('.png'));
            } catch (e) {
              console.log('No screenshots directory found');
            }

            const screenshotList = screenshotFiles.length > 0
              ? screenshotFiles.map(f => `- \`${f}\``).join('\n')
              : '- No screenshots captured';

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.body.includes('<!-- preview-screenshots-comment -->')
            );

            const body = [
              '<!-- preview-screenshots-comment -->',
              '## üì∏ Preview Screenshots',
              '',
              `Screenshots captured from [preview deployment](${previewUrl})`,
              '',
              '### Captured Views',
              '',
              '| Device | Resolution | Screenshots |',
              '|--------|------------|-------------|',
              '| üñ•Ô∏è Desktop | 1920√ó1080 | Initial + Animation |',
              '| üì± Tablet | 768√ó1024 | Initial + Animation |',
              '| üì± Mobile | 375√ó667 | Initial + Animation |',
              '',
              '<details>',
              '<summary>Screenshot files</summary>',
              '',
              screenshotList,
              '',
              '</details>',
              '',
              `**[üì• Download Screenshots](${artifactUrl})**`,
              '',
              '---',
              `<sub>Last captured: ${timestamp} ‚Ä¢ [View Workflow Run](${artifactUrl})</sub>`,
            ].join('\n');

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
              console.log('Updated existing screenshot comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
              console.log('Created new screenshot comment');
            }
